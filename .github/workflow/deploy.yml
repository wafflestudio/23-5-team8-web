name: Deploy Team8 Client Logic App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install Dependencies
        run: npm ci

      # 4. ë¦¬ì•¡íŠ¸ ë¹Œë“œ
      - name: Build
        run: npm run build
        env:
          # ì—¬ê¸°ì„œ GitHub Secretsì˜ ê°’ì„ ê°€ì ¸ì™€ì„œ ë¹Œë“œ ì‹œì ì— êµ½ìŠµë‹ˆë‹¤.
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      # 5. AWS ì¸ì¦ (ğŸŸ¢ IAM ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ëŠ” ê³¼ì •)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6. S3 ì—…ë¡œë“œ (ğŸŸ¢ IAM ê³„ì •ì´ ìˆ˜í–‰)
      - name: Upload to S3
        run: |
          # viteë¼ë©´ ./dist, CRAë¼ë©´ ./build í™•ì¸ í•„ìˆ˜!
          aws s3 sync ./dist s3://${{ secrets.AWS_S3_BUCKET }} --delete

      # 7. ìºì‹œ ì‚­ì œ (ğŸŸ¢ IAM ê³„ì •ì´ ìˆ˜í–‰)
      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CLOUDFRONT_ID }} --paths "/*"
